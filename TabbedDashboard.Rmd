---
title: "Eau Claire COVID"
#author:  "by Jessica Kraker, ____"
date:  "as of `r format(Sys.time()-0*86400, '%B %d, %Y')`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code:  https://github.com/jjkraker/EauClaireCOVIDsummary
    theme: spacelab
---

```{r setup, include=FALSE}
library(flexdashboard)
library(knitr)
library(dplyr)
library(ggplot2)
library(ggformula)
library(kableExtra)
library(tidyverse)
library(lubridate)
library(scales)
library(zoo)
library(formattable)

source("PlottingFunctions.R")

WIdata = read.csv("Data/WIdata.csv")
# names(WIdata)  
WIdata <- CaseCheck(WIdata)

ECdata = read.csv("Data/ECdata.csv")
# names(ECdata)  
ECdata <- CaseCheck(ECdata)

BAdata = read.csv("Data/BAdata.csv")
# names(BAdata)  
BAdata <- CaseCheck(BAdata)

CFdata = read.csv("Data/CFdata.csv")
# names(CFdata)  
CFdata <- CaseCheck(CFdata)

ECpop = 102388 # https://datausa.io/profile/geo/eau-claire-county-wi
EC20pop = 18430 # about 18% of 102,388 = 18,430 as number in 20s, with students
CFpop = 63445 # https://datausa.io/profile/geo/chippewa-county-wi
BApop = 45358 # https://datausa.io/profile/geo/barron-county-wi
WIpop = 5810000 # https://datausa.io/profile/geo/wisconsin 

```

Daily  {data-orientation=columns}
=====================================  
    
Column {.tabset}
-------------------------------------
**Important dates**:

   * (purple dashed lines)  **May 14**:  Stay-at-Home *reversed*;  **May 25**:  Memorial Day; **July 4**:  Independence Day 

   * (blue dashed lines)  **March 25**:  Stay-at-Home order; **Aug 1**:  WI mask mandate

   
**Note**:  due to lag time between exposure and final positive test, effects of changes are typically observed about two weeks after event.

**Comment:** Why a 7-day moving average?  Wisconsin tends to have cyclical patterns in testing results, with low spots typically on Mondays (this may be due to lower testing on weekends)


### Eau Claire

```{r,fig.height=3}
DailyCases(ECdata, "Eau Claire") 

```   

### Chippewa

```{r,fig.height=3}
DailyCases(CFdata, "Chippewa") 

```   

### Barron

```{r,fig.height=3}
DailyCases(BAdata, "Barron") 

```   

### Wisconsin

```{r,fig.height=3}
DailyCases(WIdata, "Wisconsin") 

```   



Active {.tabset}
-------------------------------------
**Active cases**:  Estimated recovery time from health experts varies between 10-20 days, with a nontrivial proportion of cases being [long-term / on-going](https://www.theatlantic.com/health/archive/2020/08/long-haulers-covid-19-recognition-support-groups-symptoms/615382/).  Even given the testing lag, a conservative approximation is to use the total number of positive (diagnosed) cases across the last 10 days.  We will go with this standard, along with a range from 10-14 days of active accumulation, and adjust as more precise information becomes available. *14 days corresponds with two-week standard in place in MN school decisions.*
   
### Eau Claire

```{r,fig.height=3}
ActiveCases(ECdata, "Eau Claire") 

```   

### Chippewa

```{r,fig.height=3}
ActiveCases(CFdata, "Chippewa") 

```   

### Barron

```{r,fig.height=3}
ActiveCases(BAdata, "Barron") 

```   

### Wisconsin

```{r,fig.height=3}
ActiveCases(WIdata, "Wisconsin") 


```


By the Numbers {data-orientation=columns}
=====================================     

Column {.tabset}
-------------------------------------
   
**Definitions** 

*Case fatality rate*, etc:  **Need to add to table** 

**Need to add to table** - Statistics computed directly from the raw data (sourced from WI DHS), stated without interpretation nor fuzziness. 

### Eau Claire
```{r}
PartialTotalTable(ECdata, "Eau Claire")



```

### Chippewa

```{r,fig.height=3}
PartialTotalTable(CFdata, "Chippewa") 

```   

### Barron

```{r,fig.height=3}
PartialTotalTable(BAdata, "Barron") 

```   

### Wisconsin {data-width=300}

```{r}
PartialTotalTable(WIdata, "Wisconsin")
```




```{r}
```

Column {.tabset}
-------------------------------------

**Source**:  [Minnesota’s safe learning plan](https://education.mn.gov/MDE/dse/health/covid19/) is very direct, very precise, with scientific basis.  Determined on a local level. **Definitions** (corresponding / similar to MN plan) and 
*SUGGESTED GUIDELINES* based off of reference:

   * **2wk**: Two-week case _total_
(most recent 14 days), **rate per** 10K of county population
   * **2wk20s**:  Approximate two-week case total, rate per 10K of 20-29 population; since over 50% of students on campus are in early 20s
   * **daily7**: Daily new-case running average (_average_ over 7 days)
 


```{r}
criteria2wk = c("> 25",  "> 28", "> 28", "> 30", "> 30")
criteria2wk20s = c("> 30",  "> 40", "> 40", "> 50", "> 50")
criteriadaily7 = c("--",  "decreasing", "steady to increasing","decreasing", "steady to increasing")

action = c("urge extra caution",
           "consider staying home and watching class recordings (rather than attending in-person) and visit online OH",
           "strongly encouraged to stay home and watch class recordings (attend in-person only as absolutely needed) and visit online OH.",
           "  ''    ''    ''  ",
           "based on the cited criteria from Minnesota, safety of in-person classes no longer seems supportable"
)

HeadertoUse <- c("Criteria 2wk",
                "Criteria 2wk20s",
                "Criteria daily7",
                "Suggestion")
DecisionTable <- tibble(Criteria_2wk=criteria2wk,
                        Criteria_2wk20s=criteria2wk20s,
                        Criteria_daily7=criteriadaily7,
                        Suggestion=action,
                        .name_repair = ~HeadertoUse)

kable(DecisionTable) %>%
  kable_styling(full_width = F) %>%
  column_spec(1, bold = T, border_right = T, border_left = T,include_thead = T) %>%
  column_spec(2, bold = T, border_right = T,include_thead = T) %>%
  column_spec(3, bold = T, border_right = T,include_thead = T) %>%
  column_spec(4, width = "40em" ,include_thead = T) %>%
  row_spec(1,background = "darkslateblue",color="white") %>%
  row_spec(2,background = "purple",color="white") %>%
  row_spec(3,background = "#d100d1",color = "white") %>%
  row_spec(4, background = "#d100d1",color = "white") %>%
  row_spec(5,background = "#ff0055",color="white") %>%
  row_spec(0, color="black")



```



### Eau Claire {data-width=100}

```{r}
SafetyCheckTable20s(ECdata, "Eau Claire", ECpop,EC20pop)
```

**Important Resources**:

   * [Eau Claire Reopening guidelines "Respond Together"](https://www.eauclairewi.gov/Home/ShowDocument?id=32685)
   * [Eau Claire County Health Department's comprehensive website on COVID and planning](https://coronavirus-and-covid-19-information-hub-eccounty.hub.arcgis.com/), with [August 20 current info](https://www.eauclairewi.gov/Home/ShowDocument?id=32975)
   * [Visual summary Eau Claire County Demographics](https://naccho.maps.arcgis.com/apps/opsdashboard/index.html#/dc74772707d94db9a7d24d30ffdcf36c)
   * [Eau Claire County Demographics](https://datausa.io/profile/geo/eau-claire-county-wi#demographics)


### Wisconsin {data-width=300}


```{r}
```

**Important Resources**:


   * [Reopening guidelines](https://www.dhs.wisconsin.gov/covid-19/prepare.htm#:~:text=Back%20Section%20Menu-,COVID-19:%20Badger%20Bounce%20Back,safest%20way%20to%20open%20Wisconsin.)
   * [Wisconsin Health Department's comprehensive website on COVID and planning](https://www.dhs.wisconsin.gov/outbreaks/index.htm)
   * [Visual summary of Wisconsin Demographics](https://naccho.maps.arcgis.com/apps/opsdashboard/index.html#/dc74772707d94db9a7d24d30ffdcf36c)


Cumulative {data-orientation=columns}
=====================================     



Column {data-width=600}{.tabset}
-------------------------------------
   
### Eau Claire
```{r}
#PartialTotalTable(ECdata, "Eau Claire")


#Cumulative – 4plot?
#Testing: Add bar chart, split between pos and neg, with response rate.
#Cumulative: line plot of logs (like Minnesota reference).  Line plot regular scale.

```

### Chippewa

```{r}
#PartialTotalTable(CFdata, "Chippewa") 

```   

### Barron

```{r}
#PartialTotalTable(BAdata, "Barron") 

```   

### Wisconsin 

```{r}
#PartialTotalTable(WIdata, "Wisconsin")
```




```{r}
```


Column {data-width=200}{.tabset}
-------------------------------------

### Eau Claire 


### Wisconsin 





References {data-orientation=rows}
=====================================     


Column {data-height=100}
-------------------------------------
    
### Data Sources {data-width=200}

   * [Wisconsin Department of Health Services](https://data.dhsgis.wi.gov/datasets/covid-19-historical-data-table/data?where=GEO%20%3D%20%27State%27) with [variable definitions](https://www.dhs.wisconsin.gov/publications/p02677.pdf)
   * [Eau Claire County statistics]( https://coronavirus-and-covid-19-information-hub-eccounty.hub.arcgis.com/)

### Reliable Updated Visuals {data-width=300}

   * Johns Hopkins dashboard (world, national, and county levels)
   * National
   * https://topic.newsbreak.com/covid-19.html?zip=19934&s=dmg_local_briefing.web2

   * [Wisconsin DHS website](https://www.dhs.wisconsin.gov/covid-19/county.htm), with interactive graphs; subsettable by county
   * [Re-opening Trends](https://www.nytimes.com/interactive/2020/07/09/us/coronavirus-cases-reopening-trends.html):  that is, why didn't the first wave end?

   
   
Column {data-height=400}
-------------------------------------

###  Visual and code references for selected plots {data-width=200}

*I devised plots that are similar to those found, for example, at the following locations:*

   * [Github repository by coolbaby0208](https://github.com/coolbaby0208/MN-COVID19)
   * Covid Act Now https://covidactnow.org/?s=58173
   * A regional breakdown of the United States COVID-19 curve https://www.reddit.com/r/dataisbeautiful/comments/heglc5/oc_a_regional_breakdown_of_the_united_states/
   * Minnesota updates from Reddit  https://www.reddit.com/r/minnesota/comments/h9j6pj/covid19_update_up_222_230_by_mdh_active_2780/ and https://www.reddit.com/r/minnesota/comments/hfovhg/625_update_34123_positives_360_1406_deaths_9/
   * [Wisconsin updates](https://www.reddit.com/r/CoronavirusWI/comments/hftc25/62520_graphs/) (from Redditor [unknown-and-alone](https://www.reddit.com/user/unknown-and-alone)) 
   * <a href="https://www.reddit.com/r/CoronavirusWI/comments/hftc25/62520_graphs/" target="_blank">Wisconsin updates</a>
   * https://www.reddit.com/r/dataisbeautiful/comments/hjwthw/oc_countylevel_covid19_case_growth_animation_in/
   * https://www.cpp.edu/~clange/covid19/Covid19ReportCaliforniaComp.html

### Scientific References for Common Questions {data-width=500}

[**Asymptomatic Spread**](https://www.pnas.org/content/early/2020/07/02/2008373117)

**Masks** Should I wear a mask in enclosed public spaces?  Unequivocally, **YES**.  References for reasoning, using a current (as of July 8) [accumulation of over 70 references](https://threader.app/thread/1279144399897866248).  A few of my favorites (modeling-wise) are:

   * [Physical distancing, face masks, and eye protection to prevent person-to-person transmission of SARS-CoV-2 and COVID-19: a systematic review and meta-analysis](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)31142-9/fulltext)
   * [Background for modelling: A modelling framework to assess the likely effectiveness of facemasks in combination with ‘lock-down’ in managing the COVID-19 pandemic](https://royalsocietypublishing.org/doi/10.1098/rspa.2020.0376)
   * [To mask or not to mask: Modeling the potential for face mask use by the general public to curtail the COVID-19 pandemic](https://www.sciencedirect.com/science/article/pii/S2468042720300117?via%3Dihub)
   * [Face Masks Considerably Reduce COVID-19 Cases in Germany: A Synthetic Control Method Approach](http://ftp.iza.org/dp13319.pdf?fbclid=IwAR1jlcs2PjDIvg3AjqxMucwVPfexpxRDOt5T3k24MzNYmTCIE0Resziaeto)

   
A couple more in the works:

   * [Face mask wearing rate predicts country's COVID-19 death rates]( https://www.medrxiv.org/content/10.1101/2020.06.22.20137745v1)
   * [Association of country-wide coronavirus mortality with demographics, testing, lockdowns, and public wearing of masks (Update June 15, 2020)]( https://www.researchgate.net/publication/342198360_Association_of_country-wide_coronavirus_mortality_with_demographics_testing_lockdowns_and_public_wearing_of_masks_Update_June_15_2020)
   * [Physical distancing, face masks, and eye protection for prevention of COVID-19](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)31183-1/fulltext?fbclid=IwAR0TSoh6w_Pl54K5ZmmNU6p_cIBo2EoP9BmSxY5Pu2K0aV95IPwk5T53Q6s)

Media articles / letters summarizing scientific publications:

   * [Petition from Minnesota Healthcare Clinicians](https://docs.google.com/forms/d/e/1FAIpQLSel_CEtyTqFjyv_XFFyhPwbH-J6gnfX0YWsiEqlBLE4bsOHGg/viewform?fbclid=IwAR2QaUjDigeGZpGDS0mszJVXqiF4OqBCLlW_9hc7pApBv4WjDlIX1ToXlV4) to Gov. Walz, submitted July 7 with 1600 signatures
   * https://www.npr.org/sections/health-shots/2020/06/21/880832213/yes-wearing-masks-helps-heres-why
   * https://www.sfgate.com/science/article/Study-100-face-mask-use-could-crush-second-15333170.php?

Modeling  {data-orientation=rows}
=====================================     


```{r}
n=dim(WIdata)[1]; start = 30 # error on neg cases at 17
allcorPOS = c()
for (k in 1:24) {
  allcorPOS = c(allcorPOS,
                (cor(log(WIdata$POSITIVE[start:(n-k)]),
                     log(WIdata$DEATHS[(k+start):n])
                     )
                 )
                )
#  plot(log(WIdata$POSITIVE[start:(n-k)]),log(WIdata$DEATHS[(k+start):n]))
}
#plot(1:24,allcorPOS)

kLogPOS = order(allcorPOS)[24]

allcorRateNEW = c()
for (k in 1:25) {
  TestsNEW = WIdata$POS_NEW[start:(n-k)]+WIdata$NEG_NEW[start:(n-k)]
  RateNEW = WIdata$POS_NEW[start:(n-k)]/TestsNEW
  allcorRateNEW = c(allcorRateNEW,
                (cor(RateNEW,
                     log(WIdata$DEATHS[(k+start):n])
                     )
                 )
                )
#  plot(RateNEW,log(WIdata$DEATHS[(k+start):n]))
}
#plot(1:25,allcorRateNEW)
kRatePOS = order(allcorRateNEW)[1]
        
k=28; 

TestsNEW = WIdata$POS_NEW[start:(n-k)]+WIdata$NEG_NEW[start:(n-k)]
RateNEW = WIdata$POS_NEW[start:(n-k)]/TestsNEW
#plot(RateNEW,log(WIdata$DEATHS[(k+start):n]),
#     col="#00CED1", lwd=2,
#     xlab="New Positives (daily) rate",
#     ylab=paste("log Deaths at lag",k)
#)
coef = lm(log(WIdata$DEATHS[(k+start):n])~log(WIdata$POSITIVE[start:(n-k)]))$coef
print(paste("The number of  cumulative deaths, at a lag of", k, "days, are approximately", round(as.numeric(exp(coef[1])),1), "times number of cumulative cases to the", round(as.numeric(coef[2]),2), "power."))
print(paste("We thus predict that on", today()+k, "the cumulative number of deaths in WI will be", round(exp(coef[1])*(max(WIdata$POSITIVE))^coef[2])))


plot(log(WIdata$POSITIVE[start:(n-k)]),log(WIdata$DEATHS[(k+start):n]), 
     col="#00CED1", type="l", lwd=2,
     xlab="log Cumulative Cases",
     ylab=paste("log Deaths at lag",k)
)
Lagdata <- data.frame(logPOStok=log(WIdata$POSITIVE[start:(n-k)]),
                     logDTHlag=log(WIdata$DEATHS[(k+start):n]))

Model1plot <- ggplot(Lagdata, aes(x=logPOStok, y=logDTHlag))+
    geom_line(aes(color="correspondence"))+
    scale_colour_manual(name=F, values=c('correspondence'='purple','Loess smooth'='grey','7-day moving avg'='navy')) + 
    ggtitle(label = paste("WI correpondence between Cumulative cases and deaths"))+
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5, lineheight = .8, face = "bold"),
          axis.text.x = element_text(angle=90))+
    ylab(paste("Log Deaths at lag", k))+
    xlab("Log Cases") 

#Model1plot


#Modeling – log deaths (blue) and transformed-log cases (red or green).

```
